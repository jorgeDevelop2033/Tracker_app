name: Deploy Tracker.WebSocket to VPS

on:
  push:
    branches:
      - master   # cambia si usas otra rama para producción

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del código
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up SSH key
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.VM_PORT }} -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      # 3. Asegurar directorio en la VPS
      - name: Ensure remote directories exist
        run: |
          ssh -p ${{ secrets.VM_PORT }} ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            mkdir -p /home/${{ secrets.VM_USER }}/tracker_websocket
          "

      # 4. Sincronizar proyecto WebSocket a VPS
      - name: Rsync Tracker.WebSocket to Remote VM
        run: |
          rsync -avz -e "ssh -p ${{ secrets.VM_PORT }}" ./src/Tracker.WebSocket/ \
          ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/home/${{ secrets.VM_USER }}/tracker_websocket

      # 5. Build y restart Docker en la VPS
      - name: Build and restart Tracker.WebSocket container
        run: |
          ssh -p ${{ secrets.VM_PORT }} ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            cd /home/${{ secrets.VM_USER }}/tracker_websocket

            # Detener y eliminar contenedor previo
            docker stop tracker_websocket || true
            docker rm tracker_websocket || true

            # Construir imagen Docker
            docker build -t tracker_websocket .

            # Ejecutar el contenedor
            docker run -d \
              --name tracker_websocket \
              -p 5137:80 \
              -v /var/log/tracker:/app/Logs \
              tracker_websocket
          EOF
